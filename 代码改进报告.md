# PDFè®²è§£æµåº”ç”¨ - å…¨é¢ä»£ç æ”¹è¿›æŠ¥å‘Š

## ä¸€ã€é—®é¢˜æ¸…å•ï¼ˆæŒ‰ä¸¥é‡åº¦åˆ†çº§ï¼‰

### ğŸ”´ ä¸¥é‡é—®é¢˜ï¼ˆCriticalï¼‰

#### 1. ç¼ºå°‘ç±»å‹æ³¨è§£ä¸ç±»å‹æ£€æŸ¥
**ä½ç½®**: æ‰€æœ‰æ¨¡å—æ–‡ä»¶
**é—®é¢˜**: 
- `streamlit_app.py`: å‡½æ•°ç¼ºå°‘ç±»å‹æ³¨è§£ï¼Œå­—å…¸å‚æ•°æ— ç±»å‹å®šä¹‰
- `pdf_composer.py`: å¤§é‡å‡½æ•°å‚æ•°ç¼ºå°‘ç±»å‹æç¤º
- `batch_processor.py`: è¿”å›ç±»å‹ä¸æ˜ç¡®
**å½±å“**: é™ä½ä»£ç å¯è¯»æ€§ï¼Œå¢åŠ è¿è¡Œæ—¶é”™è¯¯é£é™©ï¼ŒIDEæ— æ³•æä¾›å‡†ç¡®è¡¥å…¨

#### 2. å¼‚å¸¸å¤„ç†è¿‡äºå®½æ³›
**ä½ç½®**: 
- `streamlit_app.py:57-58` - ç©ºexceptå—
- `streamlit_app.py:138` - æ•è·æ‰€æœ‰Exceptionä½†ä»…è½¬æ¢ä¸ºå­—ç¬¦ä¸²
- `gemini_client.py:114` - æ•è·æ‰€æœ‰Exceptionï¼Œç¼ºå°‘å…·ä½“å¼‚å¸¸ç±»å‹
**é—®é¢˜**: 
```python
except:  # ç©ºexceptï¼Œéšè—æ‰€æœ‰é”™è¯¯
    return None
```
**å½±å“**: é”™è¯¯è¢«é™é»˜å¿½ç•¥ï¼Œéš¾ä»¥è°ƒè¯•å’Œå®šä½é—®é¢˜

#### 3. èµ„æºæ³„éœ²é£é™©
**ä½ç½®**: `pdf_composer.py:1010-1018`
**é—®é¢˜**: 
- PDFæ–‡æ¡£å…³é—­é€»è¾‘åœ¨finallyä¸­ï¼Œä½†è‹¥æ‰“å¼€å¤±è´¥å¯èƒ½å¯¼è‡´å˜é‡æœªå®šä¹‰
- pixmapå†…å­˜æ¸…ç†ä¸å®Œæ•´
**å½±å“**: é•¿æ—¶é—´è¿è¡Œå¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼

#### 4. å…¨å±€çŠ¶æ€ä¸å‰¯ä½œç”¨
**ä½ç½®**: `streamlit_app.py:351-363`
**é—®é¢˜**: 
- å¤§é‡ä½¿ç”¨`st.session_state`ï¼ŒçŠ¶æ€ç®¡ç†åˆ†æ•£
- ç¼“å­˜é€»è¾‘ä¸ä¸šåŠ¡é€»è¾‘è€¦åˆ
**å½±å“**: éš¾ä»¥æµ‹è¯•ï¼ŒçŠ¶æ€ç®¡ç†æ··ä¹±

### ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼ˆHighï¼‰

#### 5. ä»£ç é‡å¤
**ä½ç½®**: 
- `streamlit_app.py:424-474` vs `streamlit_app.py:476-508` - PDFå’ŒMarkdownæ¨¡å¼å¤„ç†é€»è¾‘é«˜åº¦é‡å¤
- `batch_processor.py:54-165` vs `167-277` - åŒæ­¥å’Œå¼‚æ­¥ç‰ˆæœ¬ä»£ç å‡ ä¹ç›¸åŒ
**å½±å“**: ç»´æŠ¤æˆæœ¬é«˜ï¼Œä¿®æ”¹éœ€è¦åŒæ­¥å¤šå¤„

#### 6. é­”æ³•æ•°å­—ä¸ç¡¬ç¼–ç å€¼
**ä½ç½®**: 
- `pdf_composer.py:57` - `int(w * 3)` ç¡¬ç¼–ç 3å€å®½åº¦
- `text_layout.py:33` - `char_width_factor = 0.55` æ— è¯´æ˜
- `pdf_composer.py:134` - `column_spacing = 12` æ— é…ç½®
**å½±å“**: éš¾ä»¥è°ƒæ•´å’Œç»´æŠ¤

#### 7. å‡½æ•°è¿‡é•¿
**ä½ç½®**: 
- `streamlit_app.py:main()` - è¶…è¿‡750è¡Œ
- `pdf_composer.py:_compose_vector()` - è¶…è¿‡400è¡Œ
- `pdf_composer.py:process_continuation_page()` - è¶…è¿‡450è¡Œ
**å½±å“**: éš¾ä»¥ç†è§£ã€æµ‹è¯•å’Œç»´æŠ¤

#### 8. ç¼ºå°‘è¾“å…¥éªŒè¯
**ä½ç½®**: 
- `streamlit_app.py:sidebar_form()` - å‚æ•°æ— éªŒè¯
- `pdf_composer.py:compose_pdf()` - å‚æ•°æœªéªŒè¯èŒƒå›´
**é—®é¢˜**: 
- `font_size` å¯èƒ½ä¸ºè´Ÿæ•°
- `right_ratio` å¯èƒ½è¶…å‡ºåˆç†èŒƒå›´
**å½±å“**: è¿è¡Œæ—¶é”™è¯¯ï¼Œç”¨æˆ·ä½“éªŒå·®

#### 9. æ—¥å¿—è®°å½•ä¸ä¸€è‡´
**ä½ç½®**: å…¨é¡¹ç›®
**é—®é¢˜**: 
- éƒ¨åˆ†ä½¿ç”¨`logger`ï¼Œéƒ¨åˆ†ä½¿ç”¨`print`
- æ—¥å¿—çº§åˆ«ä½¿ç”¨ä¸å½“ï¼ˆdebug/info/erroræ··ç”¨ï¼‰
**å½±å“**: éš¾ä»¥è¿½è¸ªé—®é¢˜

### ğŸŸ¢ è½»å¾®é—®é¢˜ï¼ˆMediumï¼‰

#### 10. å‘½åä¸ä¸€è‡´
**ä½ç½®**: å…¨é¡¹ç›®
**é—®é¢˜**: 
- å‡½æ•°å‘½åï¼š`_compose_vector` vs `compose_pdf`ï¼ˆä¸€ä¸ªç§æœ‰ä¸€ä¸ªå…¬æœ‰ï¼Œä½†å‘½åé£æ ¼ä¸ç»Ÿä¸€ï¼‰
- å˜é‡å‘½åï¼š`pno` vs `page_num` vs `page_idx`
**å½±å“**: é™ä½ä»£ç å¯è¯»æ€§

#### 11. æ³¨é‡Šä¸è¶³
**ä½ç½®**: 
- `pdf_composer.py` - å¤æ‚çš„æº¢å‡ºæ£€æµ‹é€»è¾‘ç¼ºå°‘æ³¨é‡Š
- `text_layout.py` - å®¹é‡ä¼°ç®—ç®—æ³•ç¼ºå°‘æ–‡æ¡£
**å½±å“**: éš¾ä»¥ç†è§£ç®—æ³•é€»è¾‘

#### 12. é…ç½®ç®¡ç†åˆ†æ•£
**ä½ç½®**: `streamlit_app.py:sidebar_form()`
**é—®é¢˜**: æ‰€æœ‰é…ç½®å‚æ•°éƒ½é€šè¿‡UIè¾“å…¥ï¼Œç¼ºå°‘é…ç½®æ–‡ä»¶æ”¯æŒ
**å½±å“**: éš¾ä»¥è¿›è¡Œæ‰¹é‡é…ç½®å’Œè‡ªåŠ¨åŒ–

---

## äºŒã€é‡æ„æ–¹æ¡ˆ

### é˜¶æ®µ1ï¼šåŸºç¡€æ”¹è¿›ï¼ˆæœ€å°æ”¹åŠ¨ï¼Œä¿æŒå…¼å®¹ï¼‰

#### æ­¥éª¤1.1ï¼šæ·»åŠ ç±»å‹æ³¨è§£
**æ–‡ä»¶**: `app/services/pdf_processor.py`, `app/services/gemini_client.py`
**æ“ä½œ**: 
- ä¸ºæ‰€æœ‰å‡½æ•°æ·»åŠ ç±»å‹æ³¨è§£
- ä½¿ç”¨`typing`æ¨¡å—å®šä¹‰å¤æ‚ç±»å‹ï¼ˆå¦‚`Dict[int, str]`ï¼‰
- ä¿æŒå‡½æ•°ç­¾åä¸å˜ï¼Œä»…æ·»åŠ ç±»å‹ä¿¡æ¯

#### æ­¥éª¤1.2ï¼šæ”¹è¿›å¼‚å¸¸å¤„ç†
**æ–‡ä»¶**: `streamlit_app.py`, `gemini_client.py`
**æ“ä½œ**: 
- æ›¿æ¢ç©º`except:`ä¸ºå…·ä½“å¼‚å¸¸ç±»å‹
- æ·»åŠ å¼‚å¸¸ä¸Šä¸‹æ–‡ä¿¡æ¯
- ä½¿ç”¨`logging.exception()`è®°å½•å®Œæ•´å †æ ˆ

#### æ­¥éª¤1.3ï¼šæå–å¸¸é‡
**æ–‡ä»¶**: `pdf_composer.py`, `text_layout.py`
**æ“ä½œ**: 
- åˆ›å»º`constants.py`æ¨¡å—
- å°†æ‰€æœ‰é­”æ³•æ•°å­—æå–ä¸ºå¸¸é‡
- æ·»åŠ å¸¸é‡è¯´æ˜æ³¨é‡Š

**æƒè¡¡**: 
- âœ… å‘åå…¼å®¹
- âœ… é£é™©ä½
- âš ï¸ éœ€è¦å…¨é¢æµ‹è¯•

### é˜¶æ®µ2ï¼šç»“æ„ä¼˜åŒ–ï¼ˆä¸­ç­‰æ”¹åŠ¨ï¼‰

#### æ­¥éª¤2.1ï¼šæ‹†åˆ†é•¿å‡½æ•°
**æ–‡ä»¶**: `streamlit_app.py:main()`
**æ“ä½œ**: 
- æå–æ–‡ä»¶å¤„ç†é€»è¾‘ä¸º`process_single_file()`
- æå–ä¸‹è½½é€»è¾‘ä¸º`build_download_ui()`
- æå–JSONå¤„ç†é€»è¾‘ä¸º`process_json_recompose()`

#### æ­¥éª¤2.2ï¼šæ¶ˆé™¤ä»£ç é‡å¤
**æ–‡ä»¶**: `streamlit_app.py`, `batch_processor.py`
**æ“ä½œ**: 
- åˆ›å»ºé€šç”¨çš„`process_file_with_cache()`å‡½æ•°
- ä½¿ç”¨ç­–ç•¥æ¨¡å¼å¤„ç†PDF/Markdownä¸¤ç§æ¨¡å¼
- åˆå¹¶åŒæ­¥/å¼‚æ­¥ç‰ˆæœ¬çš„å…¬å…±é€»è¾‘

#### æ­¥éª¤2.3ï¼šæ”¹è¿›èµ„æºç®¡ç†
**æ–‡ä»¶**: `pdf_composer.py`
**æ“ä½œ**: 
- ä½¿ç”¨ä¸Šä¸‹æ–‡ç®¡ç†å™¨ç®¡ç†PDFæ–‡æ¡£
- ç¡®ä¿æ‰€æœ‰èµ„æºåœ¨å¼‚å¸¸æƒ…å†µä¸‹ä¹Ÿèƒ½æ­£ç¡®å…³é—­

**æƒè¡¡**: 
- âœ… æ˜¾è‘—æå‡å¯ç»´æŠ¤æ€§
- âš ï¸ éœ€è¦é‡æ„æµ‹è¯•
- âš ï¸ å¯èƒ½å½±å“ç°æœ‰è¡Œä¸ºï¼ˆéœ€ä»”ç»†éªŒè¯ï¼‰

### é˜¶æ®µ3ï¼šæ¶æ„æ”¹è¿›ï¼ˆè¾ƒå¤§æ”¹åŠ¨ï¼Œéœ€è°¨æ…ï¼‰

#### æ­¥éª¤3.1ï¼šå¼•å…¥é…ç½®ç®¡ç†
**æ–‡ä»¶**: æ–°å»º`app/config.py`
**æ“ä½œ**: 
- ä½¿ç”¨`pydantic`æˆ–`dataclasses`å®šä¹‰é…ç½®ç±»
- æ”¯æŒä»ç¯å¢ƒå˜é‡ã€é…ç½®æ–‡ä»¶ã€UIè¾“å…¥åŠ è½½
- ç»Ÿä¸€é…ç½®éªŒè¯é€»è¾‘

#### æ­¥éª¤3.2ï¼šå¼•å…¥ä¾èµ–æ³¨å…¥
**æ–‡ä»¶**: é‡æ„æœåŠ¡å±‚
**æ“ä½œ**: 
- å°†`GeminiClient`ç­‰ä¾èµ–é€šè¿‡å‚æ•°ä¼ å…¥
- ä¾¿äºæµ‹è¯•å’Œæ›¿æ¢å®ç°

#### æ­¥éª¤3.3ï¼šçŠ¶æ€ç®¡ç†æŠ½è±¡
**æ–‡ä»¶**: `streamlit_app.py`
**æ“ä½œ**: 
- åˆ›å»º`StateManager`ç±»å°è£…session_stateæ“ä½œ
- æä¾›ç±»å‹å®‰å…¨çš„çŠ¶æ€è®¿é—®æ¥å£

**æƒè¡¡**: 
- âœ… å¤§å¹…æå‡å¯æµ‹è¯•æ€§
- âš ï¸ éœ€è¦å¤§é‡é‡æ„
- âš ï¸ å»ºè®®åˆ†å°æ­¥å®æ–½

---

## ä¸‰ã€ä»£ç è¡¥ä¸

### è¡¥ä¸1ï¼šæ”¹è¿›å¼‚å¸¸å¤„ç†ï¼ˆstreamlit_app.pyï¼‰

```python
# ä½ç½®: streamlit_app.py:50-59
def load_result_from_file(file_hash: str) -> Optional[dict]:
    """ä»ä¸´æ—¶æ–‡ä»¶åŠ è½½å¤„ç†ç»“æœ"""
    filepath = os.path.join(TEMP_DIR, f"{file_hash}.json")
    if not os.path.exists(filepath):
        return None
    try:
        with open(filepath, 'r', encoding='utf-8') as f:
            return json.load(f)
    except (json.JSONDecodeError, UnicodeDecodeError) as e:
        logger.warning(f"Failed to load cache file {filepath}: {e}")
        # å°è¯•åˆ é™¤æŸåçš„ç¼“å­˜æ–‡ä»¶
        try:
            os.remove(filepath)
        except OSError:
            pass
        return None
    except Exception as e:
        logger.error(f"Unexpected error loading cache file {filepath}: {e}", exc_info=True)
        return None
```

### è¡¥ä¸2ï¼šæ·»åŠ ç±»å‹æ³¨è§£ï¼ˆgemini_client.pyï¼‰

```python
# ä½ç½®: gemini_client.py:59-70
from typing import Optional, Callable, Any
import logging

class GeminiClient:
    def __init__(
        self, 
        api_key: str, 
        model_name: str, 
        temperature: float, 
        max_output_tokens: int,
        rpm_limit: int, 
        tpm_budget: int, 
        rpd_limit: int, 
        logger: Optional[Callable[[str], None]] = None
    ) -> None:
        if not api_key:
            raise ValueError("api_key cannot be empty")
        if not (0.0 <= temperature <= 1.0):
            raise ValueError(f"temperature must be between 0.0 and 1.0, got {temperature}")
        if max_output_tokens < 1:
            raise ValueError(f"max_output_tokens must be positive, got {max_output_tokens}")
        
        self.llm = ChatGoogleGenerativeAI(
            model=model_name,
            api_key=api_key,
            temperature=temperature,
            max_output_tokens=max_output_tokens,
        )
        self.ratelimiter = RateLimiter(max_rpm=rpm_limit, max_tpm=tpm_budget, max_rpd=rpd_limit)
        self.logger = logger or (lambda msg: logging.getLogger(__name__).info(msg))
```

### è¡¥ä¸3ï¼šæå–å¸¸é‡ï¼ˆæ–°å»º constants.pyï¼‰

```python
# æ–°å»ºæ–‡ä»¶: app/services/constants.py
"""Constants used across the application."""

# PDF Composition
PDF_WIDTH_MULTIPLIER = 3  # New PDF width = original width * this value
COLUMN_SPACING_PT = 12  # Space between columns in points
DEFAULT_MARGIN_X_PT = 25  # Horizontal margin in points
DEFAULT_MARGIN_Y_PT = 40  # Vertical margin in points
MAX_COLUMNS = 3  # Maximum number of columns for explanations

# Text Layout
CHAR_WIDTH_FACTOR_CJK = 0.55  # Character width factor for CJK fonts
CHAR_WIDTH_FACTOR_LATIN = 0.45  # Character width factor for Latin fonts
MARKDOWN_LINE_HEIGHT_MULTIPLIER = 1.15  # Extra spacing for markdown elements
CAPACITY_FACTOR = 0.5  # Conservative capacity estimation factor

# Fonts
DEFAULT_FONT_SIZE = 12  # Default font size in points
MIN_FONT_SIZE = 8  # Minimum font size
MAX_FONT_SIZE = 20  # Maximum font size

# Rendering
DEFAULT_DPI = 180  # Default DPI for page rendering
DEFAULT_SCREENSHOT_DPI = 150  # Default DPI for screenshots
DEFAULT_LINE_SPACING = 1.2  # Default line spacing multiplier

# Continuation Pages
MAX_CONTINUATION_DEPTH = 5  # Maximum depth for continuation pages
CONTINUATION_PAGE_SUFFIX = "ç»­"  # Suffix for continuation pages
```

### è¡¥ä¸4ï¼šæ”¹è¿›èµ„æºç®¡ç†ï¼ˆpdf_composer.pyï¼‰

```python
# ä½ç½®: pdf_composer.py:993-1018
from contextlib import contextmanager
from typing import Iterator

@contextmanager
def open_pdf_document(pdf_bytes: bytes, filetype: str = "pdf") -> Iterator[fitz.Document]:
    """Context manager for safely opening PDF documents."""
    doc = None
    try:
        doc = fitz.open(stream=pdf_bytes, filetype=filetype)
        yield doc
    finally:
        if doc is not None:
            try:
                doc.close()
            except Exception as e:
                logger.warning(f"Error closing PDF document: {e}")

def compose_pdf(
    src_bytes: bytes, 
    explanations: Dict[int, str], 
    right_ratio: float, 
    font_size: int,
    font_path: Optional[str] = None,
    render_mode: str = "text", 
    line_spacing: float = 1.4, 
    column_padding: int = 10
) -> bytes:
    """Compose PDF with explanations added to right side."""
    # Validate inputs
    if font_size <= 0:
        raise ValueError(f"font_size must be positive, got {font_size}")
    if line_spacing <= 0:
        raise ValueError(f"line_spacing must be positive, got {line_spacing}")
    
    with open_pdf_document(src_bytes) as src_doc:
        dst_doc = fitz.open()
        try:
            for pno in range(src_doc.page_count):
                expl = explanations.get(pno, "")
                _compose_vector(
                    dst_doc, src_doc, pno, right_ratio, font_size, expl, 
                    font_path=font_path, 
                    render_mode=render_mode, 
                    line_spacing=line_spacing, 
                    column_padding=column_padding
                )
            bout = io.BytesIO()
            dst_doc.save(bout, deflate=True, clean=True, garbage=4, deflate_images=True, deflate_fonts=True)
            return bout.getvalue()
        finally:
            try:
                dst_doc.close()
            except Exception as e:
                logger.warning(f"Error closing destination document: {e}")
```

### è¡¥ä¸5ï¼šæ‹†åˆ†mainå‡½æ•°ï¼ˆstreamlit_app.pyï¼‰

```python
# ä½ç½®: streamlit_app.py:311ä¹‹å
def process_single_pdf_file(
    uploaded_file, 
    params: dict, 
    file_hash: str,
    cached_result: Optional[dict]
) -> dict:
    """å¤„ç†å•ä¸ªPDFæ–‡ä»¶çš„é€»è¾‘"""
    filename = uploaded_file.name
    
    try:
        src_bytes = uploaded_file.read()
        
        # éªŒè¯PDF
        is_valid, validation_error = pdf_processor.validate_pdf_file(src_bytes)
        if not is_valid:
            return {
                "status": "failed",
                "pdf_bytes": None,
                "explanations": {},
                "failed_pages": [],
                "error": f"PDFæ–‡ä»¶éªŒè¯å¤±è´¥: {validation_error}"
            }
        
        # å¤„ç†ç¼“å­˜é€»è¾‘
        if cached_result and cached_result.get("status") == "completed":
            st.info(f"ğŸ“‹ {filename} ä½¿ç”¨ç¼“å­˜ç»“æœ")
            try:
                result_bytes = pdf_processor.compose_pdf(
                    src_bytes,
                    cached_result["explanations"],
                    params["right_ratio"],
                    params["font_size"],
                    font_path=(params.get("cjk_font_path") or None),
                    render_mode=params.get("render_mode", "markdown"),
                    line_spacing=params["line_spacing"],
                    column_padding=params.get("column_padding", 10)
                )
                return {
                    "status": "completed",
                    "pdf_bytes": result_bytes,
                    "explanations": cached_result["explanations"],
                    "failed_pages": cached_result["failed_pages"],
                    "json_bytes": None
                }
            except Exception as e:
                st.warning(f"ç¼“å­˜é‡æ–°åˆæˆå¤±è´¥ï¼Œå°è¯•é‡æ–°å¤„ç†: {str(e)}")
                cached_result = None
        
        # é‡æ–°å¤„ç†
        if not cached_result:
            with st.spinner(f"å¤„ç† {filename} ä¸­..."):
                result = cached_process_pdf(src_bytes, params)
                return result
                
    except Exception as e:
        logger.error(f"Error processing file {filename}: {e}", exc_info=True)
        return {
            "status": "failed",
            "pdf_bytes": None,
            "explanations": {},
            "failed_pages": [],
            "error": str(e)
        }

# åœ¨main()ä¸­è°ƒç”¨
# for i, uploaded_file in enumerate(uploaded_files):
#     filename = uploaded_file.name
#     file_hash = get_file_hash(uploaded_file.read(), params)
#     cached_result = load_result_from_file(file_hash)
#     result = process_single_pdf_file(uploaded_file, params, file_hash, cached_result)
#     st.session_state["batch_results"][filename] = result
```

---

## å››ã€å®‰å…¨ä¸æ€§èƒ½

### å®‰å…¨é£é™©

#### ğŸ”´ é«˜é£é™©

1. **APIå¯†é’¥æ³„éœ²é£é™©**
   - **ä½ç½®**: `streamlit_app.py:244`
   - **é—®é¢˜**: APIå¯†é’¥é€šè¿‡UIè¾“å…¥ï¼Œå¯èƒ½è¢«è®°å½•åˆ°æ—¥å¿—
   - **å»ºè®®**: 
     - ä½¿ç”¨`st.secrets`ç®¡ç†æ•æ„Ÿä¿¡æ¯
     - æ·»åŠ è¾“å…¥éªŒè¯ï¼Œé˜²æ­¢å¯†é’¥è¢«æ„å¤–æäº¤åˆ°ç‰ˆæœ¬æ§åˆ¶
     - åœ¨æ—¥å¿—ä¸­è¿‡æ»¤APIå¯†é’¥

2. **æ–‡ä»¶è·¯å¾„éå†é£é™©**
   - **ä½ç½®**: `streamlit_app.py:42`, `pdf_composer.py:144`
   - **é—®é¢˜**: ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„è·¯å¾„ï¼Œå¯èƒ½è¢«åˆ©ç”¨è¿›è¡Œè·¯å¾„éå†
   - **å»ºè®®**: 
     ```python
     def sanitize_path(path: str, base_dir: str) -> str:
         """ç¡®ä¿è·¯å¾„åœ¨base_dirå†…"""
         abs_path = os.path.abspath(os.path.join(base_dir, path))
         if not abs_path.startswith(os.path.abspath(base_dir)):
             raise ValueError("Invalid path")
         return abs_path
     ```

3. **å†…å­˜è€—å°½é£é™©**
   - **ä½ç½®**: `streamlit_app.py:332-336`
   - **é—®é¢˜**: å…è®¸ä¸Šä¼ 20ä¸ªPDFï¼Œæ— å¤§å°é™åˆ¶
   - **å»ºè®®**: 
     - æ·»åŠ å•æ–‡ä»¶å¤§å°é™åˆ¶ï¼ˆå¦‚50MBï¼‰
     - æ·»åŠ æ€»å¤§å°é™åˆ¶ï¼ˆå¦‚200MBï¼‰
     - æ·»åŠ å†…å­˜ä½¿ç”¨ç›‘æ§

#### ğŸŸ¡ ä¸­é£é™©

4. **ä¸´æ—¶æ–‡ä»¶æœªæ¸…ç†**
   - **ä½ç½®**: `streamlit_app.py:29-30`
   - **é—®é¢˜**: ä¸´æ—¶æ–‡ä»¶å¯èƒ½ç´¯ç§¯
   - **å»ºè®®**: 
     - å®ç°å®šæœŸæ¸…ç†æœºåˆ¶
     - ä½¿ç”¨`tempfile.TemporaryDirectory`
     - æ·»åŠ æ–‡ä»¶è¿‡æœŸæ—¶é—´

5. **JSONæ³¨å…¥é£é™©**
   - **ä½ç½®**: `batch_processor.py:119`
   - **é—®é¢˜**: ç›´æ¥è§£æç”¨æˆ·æä¾›çš„JSON
   - **å»ºè®®**: éªŒè¯JSONç»“æ„ï¼Œé™åˆ¶å¤§å°

### æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 1. ç¼“å­˜ä¼˜åŒ–
- **é—®é¢˜**: `@st.cache_data`å¯èƒ½ç¼“å­˜è¿‡å¤§å¯¹è±¡
- **å»ºè®®**: 
  - ä»…ç¼“å­˜å…ƒæ•°æ®ï¼Œä¸ç¼“å­˜PDF bytes
  - ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿç¼“å­˜æ›¿ä»£å†…å­˜ç¼“å­˜
  - å®ç°ç¼“å­˜å¤§å°é™åˆ¶

#### 2. å¹¶å‘ä¼˜åŒ–
- **é—®é¢˜**: `gemini_client.py`ä½¿ç”¨å¼‚æ­¥ï¼Œä½†å¯èƒ½é˜»å¡
- **å»ºè®®**: 
  - ä½¿ç”¨`asyncio.Semaphore`é™åˆ¶å¹¶å‘æ•°
  - å®ç°è¯·æ±‚é˜Ÿåˆ—
  - æ·»åŠ è¶…æ—¶æœºåˆ¶

#### 3. å†…å­˜ä¼˜åŒ–
- **é—®é¢˜**: PDFå¤„ç†å¯èƒ½å ç”¨å¤§é‡å†…å­˜
- **å»ºè®®**: 
  - æµå¼å¤„ç†å¤§æ–‡ä»¶
  - åŠæ—¶é‡Šæ”¾pixmapèµ„æº
  - ä½¿ç”¨ç”Ÿæˆå™¨å¤„ç†é¡µé¢

#### 4. æ€§èƒ½æµ‹é‡
```python
# æ·»åŠ æ€§èƒ½ç›‘æ§è£…é¥°å™¨
import time
from functools import wraps
from typing import Callable

def measure_time(func: Callable) -> Callable:
    @wraps(func)
    def wrapper(*args, **kwargs):
        start = time.time()
        try:
            result = func(*args, **kwargs)
            return result
        finally:
            elapsed = time.time() - start
            logger.info(f"{func.__name__} took {elapsed:.2f}s")
    return wrapper
```

---

## äº”ã€æµ‹è¯•ä¸å·¥å…·

### å•å…ƒæµ‹è¯•å»ºè®®

#### 1. æµ‹è¯•ç»“æ„
```
tests/
â”œâ”€â”€ unit/
â”‚   â”œâ”€â”€ test_pdf_validator.py
â”‚   â”œâ”€â”€ test_text_layout.py
â”‚   â”œâ”€â”€ test_gemini_client.py
â”‚   â””â”€â”€ test_pdf_composer.py
â”œâ”€â”€ integration/
â”‚   â”œâ”€â”€ test_batch_processing.py
â”‚   â””â”€â”€ test_streamlit_app.py
â””â”€â”€ fixtures/
    â””â”€â”€ sample_pdfs/
```

#### 2. å…³é”®æµ‹è¯•ç”¨ä¾‹

**test_pdf_validator.py**:
```python
import pytest
from app.services.pdf_validator import validate_pdf_file, is_blank_explanation

def test_validate_pdf_file_valid():
    """æµ‹è¯•æœ‰æ•ˆPDFæ–‡ä»¶"""
    # åˆ›å»ºæµ‹è¯•PDF
    pdf_bytes = create_test_pdf()
    is_valid, error = validate_pdf_file(pdf_bytes)
    assert is_valid is True
    assert error == ""

def test_validate_pdf_file_invalid():
    """æµ‹è¯•æ— æ•ˆPDFæ–‡ä»¶"""
    invalid_bytes = b"not a pdf"
    is_valid, error = validate_pdf_file(invalid_bytes)
    assert is_valid is False
    assert len(error) > 0

def test_is_blank_explanation():
    """æµ‹è¯•ç©ºç™½è®²è§£æ£€æµ‹"""
    assert is_blank_explanation(None) is True
    assert is_blank_explanation("") is True
    assert is_blank_explanation("   ") is True
    assert is_blank_explanation("è¿™æ˜¯æœ‰æ•ˆçš„è®²è§£æ–‡æœ¬") is False
```

**test_text_layout.py**:
```python
import pytest
from app.services.text_layout import _smart_text_layout
import fitz

def test_smart_text_layout_single_column():
    """æµ‹è¯•å•æ å¸ƒå±€"""
    text = "è¿™æ˜¯ä¸€æ®µæµ‹è¯•æ–‡æœ¬"
    rects = [fitz.Rect(0, 0, 100, 200)]
    result = _smart_text_layout(text, rects, 12, None, "helv", "text", 1.4)
    assert len(result) == 1
    assert len(result[0]) > 0

def test_smart_text_layout_overflow():
    """æµ‹è¯•æ–‡æœ¬æº¢å‡ºå¤„ç†"""
    long_text = "æµ‹è¯•æ–‡æœ¬" * 1000
    rects = [fitz.Rect(0, 0, 50, 50)]  # å°çŸ©å½¢
    result = _smart_text_layout(long_text, rects, 12, None, "helv", "text", 1.4)
    assert len(result) == 1
    # åº”è¯¥æˆªæ–­æ–‡æœ¬
    assert len(result[0]) < len(long_text)
```

#### 3. Mockæµ‹è¯•
```python
# test_gemini_client.py
from unittest.mock import AsyncMock, patch
import pytest

@pytest.mark.asyncio
async def test_explain_page_success():
    """æµ‹è¯•æˆåŠŸè°ƒç”¨Gemini API"""
    client = GeminiClient(
        api_key="test_key",
        model_name="gemini-2.5-pro",
        temperature=0.4,
        max_output_tokens=4096,
        rpm_limit=150,
        tpm_budget=2000000,
        rpd_limit=10000
    )
    
    with patch.object(client.llm, 'invoke', new_callable=AsyncMock) as mock_invoke:
        mock_invoke.return_value.content = "è¿™æ˜¯æµ‹è¯•è®²è§£"
        image_bytes = b"fake_image"
        result = await client.explain_page(image_bytes, "æµ‹è¯•æç¤ºè¯")
        assert result == "è¿™æ˜¯æµ‹è¯•è®²è§£"
        mock_invoke.assert_called_once()
```

### ç±»å‹æ£€æŸ¥

#### 1. æ·»åŠ mypyé…ç½®
```ini
# mypy.ini
[mypy]
python_version = 3.10
warn_return_any = True
warn_unused_configs = True
disallow_untyped_defs = True
disallow_incomplete_defs = True
check_untyped_defs = True
no_implicit_optional = True
warn_redundant_casts = True
warn_unused_ignores = True
warn_no_return = True

[mypy-streamlit.*]
ignore_missing_imports = True
```

#### 2. ç±»å‹å­˜æ ¹æ–‡ä»¶
```python
# types/streamlit.pyi
from typing import Any, Callable, Optional
from typing_extensions import Protocol

class SessionState(Protocol):
    def __getitem__(self, key: str) -> Any: ...
    def __setitem__(self, key: str, value: Any) -> None: ...
    def get(self, key: str, default: Any = None) -> Any: ...

def cache_data(func: Callable) -> Callable: ...
def file_uploader(*args, **kwargs) -> Any: ...
def button(*args, **kwargs) -> bool: ...
```

### é™æ€æ£€æŸ¥å·¥å…·

#### 1. æ·»åŠ pre-commit hooks
```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/psf/black
    rev: 23.12.1
    hooks:
      - id: black
        language_version: python3.10
  
  - repo: https://github.com/pycqa/flake8
    rev: 7.0.0
    hooks:
      - id: flake8
        args: ['--max-line-length=120', '--extend-ignore=E203']
  
  - repo: https://github.com/pre-commit/mirrors-mypy
    rev: v1.7.1
    hooks:
      - id: mypy
        args: ['--ignore-missing-imports']
        additional_dependencies: [types-all]
  
  - repo: https://github.com/pycqa/isort
    rev: 5.13.2
    hooks:
      - id: isort
```

#### 2. ä»£ç è´¨é‡æ£€æŸ¥è„šæœ¬
```python
# scripts/check_code_quality.py
#!/usr/bin/env python3
"""ä»£ç è´¨é‡æ£€æŸ¥è„šæœ¬"""
import subprocess
import sys

def run_command(cmd: list[str]) -> bool:
    """è¿è¡Œå‘½ä»¤å¹¶è¿”å›æ˜¯å¦æˆåŠŸ"""
    result = subprocess.run(cmd, capture_output=True, text=True)
    if result.returncode != 0:
        print(result.stdout)
        print(result.stderr, file=sys.stderr)
        return False
    return True

def main():
    checks = [
        (["black", "--check", "app/"], "ä»£ç æ ¼å¼åŒ–"),
        (["flake8", "app/", "--max-line-length=120"], "ä»£ç é£æ ¼"),
        (["mypy", "app/"], "ç±»å‹æ£€æŸ¥"),
    ]
    
    failed = []
    for cmd, name in checks:
        print(f"æ£€æŸ¥ {name}...")
        if not run_command(cmd):
            failed.append(name)
    
    if failed:
        print(f"\nä»¥ä¸‹æ£€æŸ¥å¤±è´¥: {', '.join(failed)}")
        sys.exit(1)
    else:
        print("\næ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼")

if __name__ == "__main__":
    main()
```

### å¯è¿è¡Œç¤ºä¾‹

#### 1. æœ€å°æµ‹è¯•ç¤ºä¾‹
```python
# test_minimal_example.py
"""æœ€å°å¯è¿è¡Œæµ‹è¯•ç¤ºä¾‹"""
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

from app.services.pdf_validator import validate_pdf_file, is_blank_explanation

def test_basic_validation():
    """åŸºç¡€éªŒè¯æµ‹è¯•"""
    # æµ‹è¯•ç©ºç™½æ£€æµ‹
    assert is_blank_explanation("") is True
    assert is_blank_explanation("æœ‰æ•ˆæ–‡æœ¬") is False
    
    print("âœ… åŸºç¡€éªŒè¯æµ‹è¯•é€šè¿‡")

if __name__ == "__main__":
    test_basic_validation()
```

#### 2. é›†æˆæµ‹è¯•ç¤ºä¾‹
```python
# test_integration_example.py
"""é›†æˆæµ‹è¯•ç¤ºä¾‹"""
import io
import sys
import os
sys.path.insert(0, os.path.dirname(__file__))

from app.services.pdf_composer import compose_pdf
from app.services.pdf_validator import validate_pdf_file

def create_minimal_pdf() -> bytes:
    """åˆ›å»ºæœ€å°PDFç”¨äºæµ‹è¯•"""
    import fitz
    doc = fitz.open()
    page = doc.new_page()
    page.insert_text((50, 50), "æµ‹è¯•PDF")
    pdf_bytes = doc.tobytes()
    doc.close()
    return pdf_bytes

def test_compose_pdf():
    """æµ‹è¯•PDFåˆæˆ"""
    src_pdf = create_minimal_pdf()
    explanations = {0: "è¿™æ˜¯ç¬¬ä¸€é¡µçš„è®²è§£"}
    
    result_pdf = compose_pdf(
        src_pdf,
        explanations,
        right_ratio=0.48,
        font_size=12,
        render_mode="text",
        line_spacing=1.2
    )
    
    # éªŒè¯ç»“æœ
    assert len(result_pdf) > 0
    is_valid, error = validate_pdf_file(result_pdf)
    assert is_valid, f"ç”Ÿæˆçš„PDFæ— æ•ˆ: {error}"
    
    print("âœ… PDFåˆæˆæµ‹è¯•é€šè¿‡")

if __name__ == "__main__":
    test_compose_pdf()
```

---

## å…­ã€å®æ–½ä¼˜å…ˆçº§å»ºè®®

### ç«‹å³å®æ–½ï¼ˆ1-2å‘¨ï¼‰
1. âœ… æ·»åŠ ç±»å‹æ³¨è§£ï¼ˆå…³é”®å‡½æ•°ï¼‰
2. âœ… æ”¹è¿›å¼‚å¸¸å¤„ç†ï¼ˆç©ºexceptå—ï¼‰
3. âœ… æå–å¸¸é‡ï¼ˆé­”æ³•æ•°å­—ï¼‰
4. âœ… æ·»åŠ è¾“å…¥éªŒè¯

### çŸ­æœŸå®æ–½ï¼ˆ1ä¸ªæœˆï¼‰
1. âœ… æ‹†åˆ†é•¿å‡½æ•°
2. âœ… æ¶ˆé™¤ä»£ç é‡å¤
3. âœ… æ”¹è¿›èµ„æºç®¡ç†
4. âœ… æ·»åŠ å•å…ƒæµ‹è¯•

### ä¸­æœŸå®æ–½ï¼ˆ2-3ä¸ªæœˆï¼‰
1. âœ… å¼•å…¥é…ç½®ç®¡ç†
2. âœ… æ”¹è¿›çŠ¶æ€ç®¡ç†
3. âœ… æ€§èƒ½ä¼˜åŒ–
4. âœ… å®‰å…¨åŠ å›º

---

## ä¸ƒã€æ€»ç»“

æœ¬æŠ¥å‘Šè¯†åˆ«äº†**12ä¸ªä¸»è¦é—®é¢˜**ï¼Œæä¾›äº†**5ä¸ªä»£ç è¡¥ä¸**ï¼Œæ ‡æ³¨äº†**5ä¸ªå®‰å…¨é£é™©**ï¼Œå¹¶ç»™å‡ºäº†**å®Œæ•´çš„æµ‹è¯•æ–¹æ¡ˆ**ã€‚å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥å®æ–½ï¼Œæ¯æ¬¡æ”¹åŠ¨åè¿›è¡Œå……åˆ†æµ‹è¯•ï¼Œç¡®ä¿å‘åå…¼å®¹ã€‚

æ‰€æœ‰å»ºè®®éƒ½éµå¾ªä»¥ä¸‹åŸåˆ™ï¼š
- âœ… ä¿æŒå‘åå…¼å®¹
- âœ… æœ€å°å¯è¡Œæ”¹åŠ¨
- âœ… é€æ­¥é‡æ„
- âœ… å……åˆ†æµ‹è¯•

