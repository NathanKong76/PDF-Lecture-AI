# PDF溢出未生成续页问题排查清单

## 可能原因分类

### 一、溢出检测失败（最可能的原因）

1. **CSS `overflow: hidden` 隐藏了溢出内容**
   - 位置：`constrained_html` 中设置了 `overflow: hidden`
   - 问题：这会隐藏溢出，导致 `get_text("blocks")` 无法检测到真正溢出
   - 严重程度：高

2. **`get_text("blocks")` 失败但容量估算不准确**
   - 位置：第526-558行
   - 问题：失败时依赖容量估算，但估算可能不够保守，导致未检测到溢出
   - 严重程度：高

3. **块过滤逻辑遗漏了溢出块**
   - 位置：第570-573行
   - 问题：块中心点判断可能仍然过于严格，遗漏了部分溢出块
   - 严重程度：中

4. **溢出阈值仍然过高**
   - 位置：第580-584行（0.2 line_height）和第590行（0.15 line_height）
   - 问题：虽然降低了，但对于某些情况可能仍然不够敏感
   - 严重程度：中

5. **HTML渲染后块检测时机问题**
   - 位置：第518行之后
   - 问题：`insert_htmlbox` 完成后立即检测，但渲染可能需要时间
   - 严重程度：低

### 二、leftovers 未正确生成

6. **get_text失败时未强制标记溢出**
   - 位置：第526-558行
   - 问题：如果容量估算认为没有溢出，就设置为空字符串
   - 严重程度：高

7. **所有leftovers都是空字符串但实际有溢出**
   - 位置：第484行初始化为空列表，可能所有列都未检测到
   - 问题：如果所有检测路径都失败，leftovers会全部为空
   - 严重程度：高

8. **HTML模式下块检测完全失败**
   - 位置：第562-573行
   - 问题：如果 `page_blocks` 为空或过滤后 `column_blocks` 为空，就不会检测到溢出
   - 严重程度：高

### 三、续页函数调用问题

9. **`has_overflow` 判断错误**
   - 位置：第944行
   - 问题：如果所有 `leftovers` 都是空字符串，`any(len(leftover) > 0)` 返回False
   - 严重程度：高

10. **`process_continuation_page` 提前退出**
    - 位置：第715行
    - 问题：如果传入的 `current_leftovers` 都为空，会立即返回
    - 严重程度：中

### 四、容量估算问题

11. **容量估算过于乐观**
    - 位置：`_smart_text_layout` 和 `estimated_capacity`
    - 问题：0.75因子可能仍然太高，导致文本分配过多
    - 严重程度：中

12. **文本分配时未考虑实际渲染效果**
    - 位置：`_smart_text_layout`
    - 问题：估算基于理论值，但HTML渲染可能有额外开销
    - 严重程度：中

### 五、渲染模式特定问题

13. **Markdown渲染的CSS导致检测失败**
    - 位置：HTML CSS定义
    - 问题：某些CSS样式可能影响块检测
    - 严重程度：低

14. **HTML元素（表格、列表）占用额外空间**
    - 位置：HTML渲染
    - 问题：表格、列表等元素的实际高度超过估算
    - 严重程度：中

## 修复优先级

1. **立即修复**：移除或修改 `overflow: hidden`，确保检测可见
2. **立即修复**：`get_text` 失败时采用更保守策略
3. **立即修复**：增加防御性检测，即使所有检测都失败也强制检查
4. **高优先级**：降低容量估算因子，更保守地分配文本
5. **高优先级**：改进溢出阈值，更敏感地检测
6. **中优先级**：添加详细日志便于调试

